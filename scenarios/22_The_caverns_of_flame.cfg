#textdomain wesnoth-The_Earths_Gut

#define INITIALIZE_CAMPAIGN_VARIABLES
#enddef
#define CLEAR_CAMPAIGN_VARIABLES
#enddef
#define INITIALIZE_SCENARIO_VARIABLES
    {VARIABLE bSeenDragon no}
    {VARIABLE bKilledDragon no}
#enddef
#define CLEAR_SCENARIO_VARIABLES
    {CLEAR_VARIABLE bSeenDragon}
    {CLEAR_VARIABLE bKilledDragon}
#enddef
#define CAVERNS_OF_FLAME
#enddef

[scenario]
    ################################################################
    # scenario head

    id=22_The_caverns_of_flame
    name= _ "The Caverns of Flame"
    map_data={TEG_MAP 22_The_caverns_of_flame.map}
    victory_when_enemies_defeated=no
    {TURNS 99 88 77}
    {UNDERGROUND}

    {MOOD_BATTLE}
    {MOOD_EPIC}
    {MOOD_UNDERGROUND}

    [story]
        [part]
            story= _ "Meanwhile, Dulatus was entering the Caverns of Flame. The air crackled with the heat of nearby lava. It became clearer and clearer that this was the heart of a volcano."
            background=scenery/flames01.png
            scale_background=no # I could go either way on this... if no, it's too small, but if yes, it's too pixelated...
        [/part]
    [/story]
    # Uh... 4 separate travel maps?! Wtf?! Not sure which one to use...
#ifdef __UNUSED__
    {TRAVELMAP_THE_HAMMER_OF_THURSAGAN}
    {TRAVELMAP_OLD_ALLIANCE}
    {TRAVELMAP_ENDGAME}
    {TRAVELMAP_EPILOGUE}
#endif

    ################################################################
    #sides
    [side]
        # player
        side=1
        controller=human
        # Even though this scenario is a Dulatus scenario, we need to start as Hamel anyways for the HAMEL_TO_DULATUS macro to work:
        type=Advanced Dwarvish Fighter
        id=Hamel
        name= _ "Hamel"
        persistent=yes
        save_id=human_player
        team_name=resistance
        {FLAG_VARIANT knalgan}
#ifdef DEBUG_MODE
        {GOLD 220 210 200}
        canrecruit=yes
#else
        {GOLD 0 0 0}
        {NO_INCOME}
        canrecruit=no
        shroud=yes
        fog=yes
#endif
    [/side]

    # Custom enemy AI instructions are mostly fine now; I've actually gotten the spider to behave properly at least once now; still might be worth keeping an eye on, though...
    # Current gold/income amounts are pretty arbitrary, but then again, they might be fine already? I dunno...
    # TODO: give enemy leaders names

    # Bottom left, nearer the player (compared to side 4), at 14,55:
    [side]
        side=2
        controller=ai
        type=Death Knight
        # TODO: name
        recruit=Chocobone # cost: 38g
        team_name=undead
        {GOLD 40 80 120} # i.e., 1 Chocobone, 2 Chocobones, or 3 Chocobones
        {INCOME 1 2 3}
        # Let's have this AI be offensive:
        [ai]
            aggression=1.0
            caution=0.0
            grouping=offensive
            leader_aggression=1.0
            leader_value=4.0
            recruitment_pattern=scout # (yes, Chocobones count as scouts...)
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value={ON_DIFFICULTY 5 6 7}
            [/goal]
        [/ai]
    [/side]

    # Kinda central-ish, near the player, at 34,50:
    [side]
        side=3
        controller=ai
        # side 3's starting location isn't a keep, so make them monsters:
        type=Giant Spider
        canrecruit=no
        team_name=monsters
        # Use a micro AI for this in an event later, too, but let's still give it some AI here, too:
        [ai]
            [avoid]
                [filter_adjacent_location]
                    [filter]
                        canrecruit=yes
                    [/filter]
                [/filter_adjacent_location]
                [or]
                    terrain=*^V*
                [/or]
            [/avoid]
            scout_village_targeting=0.0
            village_value=0.0
            villages_per_scout=0
            [goal]
                [criteria]
                    race=dwarf
                [/criteria]
                value={ON_DIFFICULTY 7 8 9}
            [/goal]
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value={ON_DIFFICULTY 5 6 7}
            [/goal]
        [/ai]
    [/side]

    # Bottom left, a bit farther in (compared to side 2), at 7,53:
    [side]
        side=4
        controller=ai
        type=Lich
        # TODO: name
        recruit=Fire Guardian # Cost 19g
        team_name=undead
        {GOLD 40 80 120} # i.e., 2 Fire Guardians, 4 Fire Guardians, or 6 Fire Guardians
        {INCOME 1 2 3}
        # Just keep this AI the default; no custom code here
    [/side]

    # Top left, at 8,5:
    [side]
        side=5
        controller=ai
        # As with side 3, side 5's starting location isn't a keep, either, so make them monsters, too:
        type=Fire Dragon
        id=firedragon
        canrecruit=no
        team_name=monsters
        shroud=yes
        fog=yes
        # This side will get a micro AI in an event later, too, but for now let's do this:
        [ai]
            [avoid]
                [filter_adjacent_location]
                    [filter]
                        canrecruit=yes
                        [or]
                            type=Skeletal Dragon,Fire Guardian
                        [/or]
                    [/filter]
                [/filter_adjacent_location]
                [or]
                    terrain=*^V*
                [/or]
            [/avoid]
            scout_village_targeting=0.0
            village_value=0.0
            villages_per_scout=0
        [/ai]
    [/side]

    # Upper-ish right, at 36,22:
    [side]
        side=6
        controller=ai
        # timeline.txt says the dwarf-lich only awakened one Ancient Lich, so just make this one that's closest to the hammer the ancient one:
        type=Ancient Lich
        # TODO: name
        recruit=Skeletal Dragon # Cost: 100g
        team_name=undead
        {GOLD 100 200 300} # i.e., 1 Skeletal Dragon, 2 Skeletal Dragons, or 3 Skeletal Dragons
        {INCOME 3 6 9}
        # Let's have their AI be focused on protecting the hammer:
        [ai]
            aggression=0.1
            caution=0.9
            grouping=defensive
            recruitment_pattern=fighter
            [goal]
                name=protect_location
                [criteria]
                    location_id="sceptre"
                [/criteria]
                protect_radius=10
                value={ON_DIFFICULTY 5 6 7}
            [/goal]
            [goal]
                name=target_location
                [criteria]
                    location_id="sceptre"
                [/criteria]
                value={ON_DIFFICULTY 4 5 6}
            [/goal]
            [goal]
                name=protect_unit
                [criteria]
                    # Corrupted dwarf-lich will also be able to recruit once it appears, so these criteria should match it as well:
                    side=6
                    canrecruit=yes
                [/criteria]
                protect_radius=6 # equal to Ancient Lich MP
                value={ON_DIFFICULTY 3 4 5}
            [/goal]
        [/ai]
        # (Corrupted dwarf-lich will be added to this side later in an event)
    [/side]

    # Bottom right, at 47,57:
    [side]
        side=7
        controller=ai
        type=Lich
        # TODO: name
        recruit=Dread Bat # Cost: 34g (and yes, only the Dread ones; there's dialogue about it)
        team_name=undead
        {GOLD 40 80 120} # i.e., 1 bat, 2 bat, or 3 bats
        {INCOME 1 2 3}
        # Let's have their AI be focused on scouting:
        [ai]
            grouping=no
            scout_village_targeting=4.0
            village_value=2.0
            villages_per_scout=1
            recruitment_pattern=scout
        [/ai]
    [/side]

    ###################################################################################################################
    # prestart

    {SETUP_LUA}
    {SAVEFILE_COMPATIBILITY}

    [event]
        name=prestart
        {INITIALIZE_CAMPAIGN_VARIABLES}
        {INITIALIZE_SCENARIO_VARIABLES}
        [objectives]
            side=1
            summary=_"Starting Objectives:"
            [objective]
                description=_"Find the Hammer of Thursagan"
                condition=win
            [/objective]
            # TODO: maybe don't allow this as an alternate objective?
            {ALTERNATIVE_OBJECTIVE _"Defeat all enemy leaders."}
            [objective]
                description=_"Death of Dulatus"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Aiglathing"
                condition=lose
                [show_if]
                    [have_unit]
                        id=Aiglathing
                    [/have_unit]
                [/show_if]
            [/objective]
            # TODO: remove this note once it's possible to do so:
            note=_"Due to this campaign being incomplete, this is the final scenario for now. The intention is to develop one more scenario to go after it, though. So, eventually it won't be the final scenario anymore!"
        [/objectives]

        [item]
            # location_id is called "sceptre" instead of "hammer" because I was copying from HttT's S17 ("Scepter of Fire")
            location_id="sceptre"
            image=items/hammer-runic.png
        [/item]

        # This next section is copied from S08 ("Lost"):
        ############################################################################################
        # leader flip section

        # Fill the Dulatus variable appropriately while developing this scenario, in case that the storing in scenario 20 was skipped.
        [if]
            [variable]
                name=u_Dulatus.length
                less_than=1
            [/variable]
            [and]
                [not]
                    [have_unit]
                        side=1
                        id=Dulatus
                        search_recall_list=yes
                    [/have_unit]
                [/not]
            [/and]
            [then]
                [unit]
                    type=Dwarvish Stalwart
                    id=Dulatus
                    side=1
                    profile="portraits/Dulatus.png"
                    name= _ "Dulatus"
                    unrenamable=yes
                    [modifications]
                        {TRAIT_LOYAL}
                        {TRAIT_HEALTHY}
                    [/modifications]
                    {IS_HERO}
                    advances_to=Dulatus Level Three
                    to_variable=u_Dulatus
                [/unit]
            [/then]
        [/if]

        # wmllint: recognize Dulatus
        # wmllint: recognize Hamel
        {HAMEL_TO_DULATUS} # (defined in utils/units.cfg)
        # store Hamel's loyal units:
        [store_unit]
            variable=u_HamelLoyalUnits
            [filter]
                side=1
                [not]
                    id=Dulatus
                [/not]
                [filter_wml]
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications]
                [/filter_wml]
            [/filter]
            kill=true
        [/store_unit]
        # store the rest of the recall list:
        [store_unit]
            variable=u_HamelRecallList
            [filter]
                side=1
                [not]
                    id=Dulatus
                [/not]
            [/filter]
            kill=true
        [/store_unit]
        # store Hamel's gold:
        [store_gold]
            side=1
            variable=i_HamelGold
        [/store_gold]
        [modify_side]
            side=1
            gold=0
        [/modify_side]
        # and no friends to recruit:
        [disallow_recruit]
            side=1
            type=Dwarvish Fighter,Dwarvish Thunderer,Alchemist,Dwarvish Scout,Dwarvish Guardsman,Mage
        [/disallow_recruit]
        # leader flip section ends
        ############################################################################################

        [store_unit]
            variable=u_Dulatus
            [filter]
                id=Dulatus
            [/filter]
            kill=true
        [/store_unit]
        {VARIABLE u_Dulatus.x 33}
        {VARIABLE u_Dulatus.y 64}
        [hide_unit]
            x=$u_Dulatus.x
            y=$u_Dulatus.y
        [/hide_unit]
        [unstore_unit]
            variable=u_Dulatus
        [/unstore_unit]

        {FOREACH uDulatusUnits i_CurrentUnit}
            [unstore_unit]
                variable=uDulatusUnits[$i_CurrentUnit]
                x,y=33,64 # side 1's starting location
                find_vacant=yes
            [/unstore_unit]
        {NEXT i_CurrentUnit}
        {CLEAR_VARIABLE uDulatusUnits}
        [heal_unit]
            [filter]
                side=1
            [/filter]
            moves=full
            restore_attacks=yes
        [/heal_unit]
        # FIXME: somehow we end up with 2 Dulatuses; there should only be one.

        # Micro AI section:
        [micro_ai]
            side=3
            ai_type=big_animals
            action=add

            [filter]
                type=Giant Spider
            [/filter]
            [avoid_unit]
                canrecruit=yes
            [/avoid_unit]
            [filter_location]
                terrain=Uu,Uue,Uh,Uu^Uf
                [or]
                    [filter]
                        race=dwarf
                    [/filter]
                [/or]
            [/filter_location]
        [/micro_ai]

        [micro_ai]
            side=5
            ai_type=hunter
            action=add

            id=firedragon
            [filter_location]
                [filter]
                    race=dwarf
                [/filter]
            [/filter_location]
            home_x,home_y=8,5
            rest_turns=2
#ifdef DEBUG_MODE
            show_messages=yes
#endif
        [/micro_ai]
    [/event]

    [event]
        name=start
        [message]
            side=1
            message=_"Let's go find that hammer! It's got to be around here somewhere!"
        [/message]
        # TODO: need to find which of these healing potions an enemy unit is taking, find which enemy it is, and then stop them from doing that:
        {OBJ_POTION_HEALING 5 51 healingpotion1}
        {OBJ_POTION_HOLY 14 51 holywater1}
        {OBJ_POTION_STRONG 33 68 strengthpotion1}
        {OBJ_POTION_HOLY 31 68 holywater2}
        {OBJ_POTION_STRONG 28 65 strengthpotion2}
        {OBJ_POTION_HEALING 47 50 healingpotion2}
        {OBJ_POTION_HOLY 42 26 holywater3}
        {OBJ_POTION_HEALING 12 31 healingpotion3}
        {OBJ_POTION_STRONG 8 43 strengthpotion3}
        {OBJ_POTION_HEALING 4 46 healingpotion4}
        {PLACE_IMAGE "scenery/nest-empty.png" 8 5}
    [/event]

    # TODO: more dialogue on encountering/killing the various enemies
    [event]
        name=sighted
        [filter]
            type=Dread Bat
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message=_"Wow, the bats sure are large around here!"
        [/message]
    [/event]

#ifdef __UNUSED__
    [event]
        name=sighted
        [filter]
            side=1
        [/filter]
        [filter_second]
            type=Dread Bat
        [/filter_second]
        [message]
            speaker=unit
            message=_"I think I saw a giant bat approaching!"
        [/message]
    [/event]
#endif

    [event]
        name=die
        [filter]
            type=Dread Bat
        [/filter]
        [filter_second]
            side=1
            [filter_vision]
                visible=yes
            [/filter_vision]
        [/filter_second]
        [message]
            speaker=second_unit
            # wmllint: local spelling furball!
            message=_"Take that, you filthy flying furball!"
        [/message]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            side=7
            type=Dread Bat
        [/filter]
        # Ensure side 7 always has enough gold to recruit a new one:
        [store_gold]
            side=7
            variable=s7gold
        [/store_gold]
        [if]
            [variable]
                name=s7gold
                less_than={ON_DIFFICULTY 34 37 40}
            [/variable]
            [and]
                [not]
                    [have_unit]
                        side=7
                        type=Dread Bat
                    [/have_unit]
                [/not]
            [/and]
            [then]
#ifdef DEBUG_MODE
#ifdef DEBUG_MSG
                {DEBUG_MSG "Giving Side 7 some more gold for another bat"}
#endif
#ifdef DEBUG
                {DEBUG "Giving Side 7 some more gold for another bat"}
#endif
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message=_"Giving Side 7 some more gold for another bat."
                [/message]
#endif
                [gold]
                    side=7
                    amount={ON_DIFFICULTY 34 37 40}
                [/gold]
            [/then]
            [else]
#ifdef DEBUG_MODE
#ifdef DEBUG_MSG
                {DEBUG_MSG "Side 7 already has enough gold: $s7gold (or they already have another bat)"}
#endif
#ifdef DEBUG
                {DEBUG "Side 7 already has enough gold: $s7gold (or they already have another bat)"}
#endif
                [message]
                    speaker=narrator
                    image=wesnoth-icon.png
                    message=_"Side 7 already has enough gold: $s7gold (or they already have another bat)."
                [/message]
#endif
            [/else]
        [/if]
        {CLEAR_VARIABLE s7gold}
    [/event]

    [event]
        name=sighted
        [filter]
            type=Giant Spider
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message=_"Eek! A giant spider!"
        [/message]
    [/event]

    # That's probably enough dialogue about the spider; it's really rather minor, and really, who even wants to be seeing it that much, anyways?

    [event]
        name=sighted
        [filter]
            type=Fire Dragon
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [if]
            [variable]
                name=bSeenDragon
                boolean_not_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=second_unit
                    message=_"A dragon!"
                [/message]
                {VARIABLE bSeenDragon yes}
            [/then]
        [/if]
    [/event]

    [event]
        name=sighted
        [filter]
            side=1
            [filter_vision]
                visible=yes
            [/filter_vision]
        [/filter]
        [filter_second]
            type=Fire Dragon
            [filter_vision]
                visible=yes
            [/filter_vision]
        [/filter_second]
        [if]
            [variable]
                name=bSeenDragon
                boolean_not_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=unit
                    message=_"A dragon approaches!"
                [/message]
                {VARIABLE bSeenDragon yes}
            [/then]
        [/if]
    [/event]

    [event]
        name=attack
        [filter]
            side=1
            [not]
                race=drake
            [/not]
        [/filter]
        [filter_second]
            id=firedragon
        [/filter_second]
        [message]
            speaker=unit
            message=_"You may be big, you loathsome lava lizard, but that won't stop me from defeating you!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=firedragon
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message=_"I think I did it!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=firedragon
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            # FIXME: this line seems kind of stupid if the player has already found its nest; maybe add some sort of visibility check for it:
            message=_"Yes! I have slain a dragon! Now let's see if we can find its nest..."
        [/message]
        {VARIABLE bKilledDragon yes}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=8,5
            [/filter_location]
        [/filter]
        [if]
            [variable]
                name=bSeenDragon
                boolean_equals=yes
            [/variable]
            [then]
                [if]
                    [have_unit]
                        id=firedragon
                    [/have_unit]
                    [then]
                        [message]
                            speaker=unit
                            message=_"Hey, it's the nest of that dragon from before!"
                        [/message]
                    [/then]
                    [elseif]
                        [variable]
                            name=bKilledDragon
                            boolean_equals=yes
                        [/variable]
                        [then]
                            [message]
                                speaker=unit
                                message=_"Hey, it's the nest of that dragon we killed!"
                            [/message]
                        [/then]
                    [/elseif]
                    [else]
                        [message]
                            speaker=unit
                            message=_"Hey, it's the nest of that dragon that... uh, wait, what happened to it again? It died, right? Well, anyways, this is its nest!"
                        [/message]
                    [/else]
                [/if]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message=_"Hey look, it's some dragon's nest! I hope its guardian isn't nearby..."
                [/message]
            [/else]
        [/if]
        # TODO: what should be inside it? Some sort of artifact?
    [/event]

    # Still need dialogue for encountering/fighting/killing:
    # - each of the liches, but especially the Ancient one on side 6 (would require naming)
    # - the death knight
    # - skeletal dragons

    [event]
        name=sighted
        [filter]
            type=Fire Guardian
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message=_"Wow, the heat has grown so strong that even the flames are coming alive here!"
        [/message]
    [/event]

    # (that's probably enough for the fire guardians)

    [event]
        name=sighted
        [filter]
            type=Ancient Lich
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=second_unit
            message=_"This Lich seems much older than the rest we've seen! In fact, I'd say it seems positively ancient!"
        [/message]
        # TODO: More dialogue here once the Lich is named; see timeline.txt for info
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=33,55
            [/filter_location]
        [/filter]
        [move_unit_fake]
            type=Cave Drake
            x=33,32
            y=55,54
        [/move_unit_fake]
        [unit]
            side=1
            type=Cave Drake
            id=drakefriend
            x,y=32,54
            facing=se
            [modifications]
#ifdef EASY
                {TRAIT_QUICK}
                {TRAIT_FEARLESS}
#else
                {TRAIT_WEAK}
                {TRAIT_FERAL_MUSTHAVE}
#endif
            [/modifications]
        [/unit]
        [message]
            speaker=unit
            message=_"A drake was hiding here! And it looks friendly!"
        [/message]
        [message]
            # This dialogue should still work even if Dulatus is the unit that moved here:
            speaker=Dulatus
            message=_"Hm, it looks rather small and weak... it's probably atrophied from being stuck in a cave for so long... oh well, I guess it could still be helpful!"
        [/message]
        [message]
            speaker=unit
            # wmllint: local spelling whaddaya
            message=_"Well, whaddaya say, li'l guy? Wanna come along and help us find the Hammer of Thursagan?"
        [/message]
        [message]
            speaker=drakefriend
            # I'm not sure how this drake should talk, so just keep it silent for now:
            message=_"..."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=39,32
            [/filter_location]
        [/filter]
        [unit]
            side=1
            type=Dwarvish Flamethrower
            id=crazydwarf1
            x,y=39,32
            passable=yes
            random_traits=yes
        [/unit]
        [message]
            speaker=crazydwarf1
            # wmllint: local spelling FIIIIIRE!!!
            message=_"FIIIIIRE!!!"
        [/message]
        [message]
            speaker=unit
            message=_"A dwarf all the way down here?! How have you survived?!"
        [/message]
        [message]
            speaker=crazydwarf1
            message=_"By harnessing the power of fire! The creepy-crawlies 'round here don't like it one bit! Say, you wouldn't happen to be having any trouble with them, would you?"
        [/message]
        [message]
            speaker=unit
            message=_"Funny you should mention it. We were just hoping to borrow your power!"
        [/message]
        [message]
            speaker=crazydwarf1
            message=_"My pleasure! FIIIIIRE!!!"
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=5,41
            [/filter_location]
        [/filter]
        [unit]
            side=1
            type=Dwarvish Berserker
            id=crazydwarf2
            x,y=5,41
            passable=yes
            random_traits=yes
        [/unit]
        [message]
            speaker=crazydwarf2
            message=_"ARGLE BARGLE DARFIN' HARGLESTONE!" # wmllint: no spellcheck
        [/message]
        [message]
            speaker=unit
            message=_"Hm, this dwarf appears to have lost the ability to speak intelligently... he still appears to be able to fight, though! Let's take him along with us!"
        [/message]
        [message]
            speaker=crazydwarf2
            message=_"Whaddaya mean with that “lost the ability to speak intelligently” nonsense? I just occasionally... GANK! ...have random... BERGKONSTEIN! ...outbursts of anger, that's all!"
        [/message]
        [message]
            speaker=unit
            message=_"...o...kay then. (<i>aside</i>) <small><i>...better be careful with this one...</i></small>"
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=4,11
            [/filter_location]
        [/filter]
        [unit]
            side=1
            type={ON_DIFFICULTY (Dwarvish Explorer) (Dwarvish Pathfinder) (Dwarvish Scout)}
            id=crazydwarf3
            x,y=4,11
            passable=yes
            random_traits=yes
        [/unit]
        [message]
            speaker=crazydwarf3
            message=_"So, just so yeh know, if yer lookin' fer the Hammer of Thursagan, this is the wrong way. There <b>is</b> a dragon around these ways, though!"
        [/message]
        [if]
            [variable]
                name=bSeenDragon
                boolean_equals=yes
            [/variable]
            [then]
                [if]
                    [have_unit]
                        id=firedragon
                    [/have_unit]
                    [then]
                        [message]
                            speaker=unit
                            message=_"We know, we've seen that dragon ourselves!"
                        [/message]
                    [/then]
                    [elseif]
                        [variable]
                            name=bKilledDragon
                            boolean_equals=yes
                        [/variable]
                        [then]
                            [message]
                                speaker=unit
                                message=_"We know, we've seen that dragon ourselves, and we even killed it!"
                            [/message]
                        [/then]
                    [/elseif]
                    [else]
                        [message]
                            speaker=unit
                            message=_"We know, we've seen that dragon ourselves, and now it's dead!"
                        [/message]
                    [/else]
                [/if]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message=_"A dragon?! We'll be sure to watch out for it!"
                [/message]
            [/else]
        [/if]
        [message]
            speaker=unit
            message=_"Anyways, how do you know about the Hammer of Thursagan?"
        [/message]
        [message]
            speaker=crazydwarf3
            message=_"I almost retrieved it myself! I've been exploring down here for years and came pretty close to it, but unfortunately it's just too dangerous for me to get much closer by myself..."
        [/message]
        [message]
            speaker=unit
            message=_"Well, how about you join up with us, then?"
        [/message]
        [message]
            speaker=crazydwarf3
            message=_"I was hoping you'd ask! Follow me!"
        [/message]
        [move_unit]
            id=crazydwarf3
            to_x=6
            to_y=13
        [/move_unit]
        [message]
            speaker=crazydwarf3
            message=_"There's a way through the wall here!"
        [/message]
        [scroll_to_unit]
            id=crazydwarf3
        [/scroll_to_unit]
        [animate_unit]
            flag=attack
            [filter]
                id=crazydwarf3
            [/filter]
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                [filter_adjacent_location]
                    # for some reason direction has to be backwards here; we actually want to be facing southeast:
                    adjacent=nw
                    # (I guess it means, "crazydwarf3 is standing nw from the tile he's supposed to be facing"?)
                    [filter]
                        id=crazydwarf3
                    [/filter]
                [/filter_adjacent_location]
            [/facing]
            hits=yes
        [/animate_unit]
        [animate_unit]
            flag=attack
            [filter]
                id=crazydwarf3
            [/filter]
            [primary_attack]
                range=melee
            [/primary_attack]
            [facing]
                [filter_adjacent_location]
                    # See note above:
                    adjacent=nw
                    [filter]
                        id=crazydwarf3
                    [/filter]
                [/filter_adjacent_location]
            [/facing]
            hits=yes
        [/animate_unit]
        [sound]
            name=cave-in.ogg
        [/sound]
        [terrain]
            x,y=7,14
            terrain=Uh^Dr
        [/terrain]
        [message]
            speaker=crazydwarf3
            message=_"This way! It's to the east from here!"
        [/message]
    [/event]

    # additional findable friendly units to consider adding to this level:
    # - some sort of mainline drake, not sure which
    # - {ON_DIFFICULTY (Great Mage) (Arch Mage) (Red Mage)}
    # - Silver Mage

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            [filter_location]
                location_id="sceptre"
            [/filter_location]
        [/filter]
        [message]
            speaker=unit
            message=_"We found it!"
        [/message]
        [unit]
            type=Undead Dwarvish Rune Lord
            canrecruit=yes
            side=6
            id=dwarflich
            # TODO: name
            # also maybe consider giving him an extra_recruit entry?
            upkeep=free
            ai_special=guardian
            profile="portraits/karrag.png~RIGHT()"
            x,y=41,14
            passable=yes
            [modifications]
                {TRAIT_UNDEAD}
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        [message]
            speaker=dwarflich
            message=_"Oh no you don't! That's <b>MY</b> hammer!"
        [/message]
        [message]
            speaker=unit
            message=_"Wait... what? Who are you? And more importantly, WHAT are you? You seem dwarvish, and yet an aura of death and evil emanates from you..."
        [/message]
        # TODO: more dialogue once the Dwarf Lich is named (see timeline.txt for info)

        [gold]
            side=6
            # These amounts assume side 6's recruit list is still just Skeletal Dragons; adjust accordingly if giving the dwarf-lich extra recruits:
            amount={ON_DIFFICULTY 100 200 300}
        [/gold]

        # Maybe modify side 6's AI here, too? I dunno; hopefully it'll be fine as-is...

        [objectives]
            side=1
            summary=_"Final Objectives:"
            [objective]
                # Maybe adjust wording since dwarf-lich is already (un)dead:
                description=_"Kill the corrupted dwarf-lich who guards the Hammer of Thursagan"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Dulatus"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Aiglathing"
                condition=lose
                [show_if]
                    [have_unit]
                        id=Aiglathing
                    [/have_unit]
                [/show_if]
            [/objective]
            # TODO: remove this note once it's possible to do so:
            note=_"Due to this campaign being incomplete, this is the final scenario for now. The intention is to develop one more scenario to go after it, though. So, eventually it won't be the final scenario anymore!"
        [/objectives]

        [event]
            name=last breath
            [filter]
                id=dwarflich
            [/filter]
            [message]
                speaker=dwarflich
                message=_"Noooo! My hammer!"
            [/message]
        [/event]
        [event]
            name=die
            [filter]
                id=dwarflich
            [/filter]
            [kill]
                # Just making sure he won't get shown being killed again in the time we do it with animation later:
                id=dwarflich
            [/kill]
            [delay]
                time=1000
            [/delay]
            {TEG_EARTHQUAKE}
            # TODO: script more of a cutscene to play here (see timeline.txt for things that need to happen here)
            [kill]
                side=2,3,4,5,6,7
                animate=yes # just trying this for now; if it doesn't work it can be removed
            [/kill]
            {TEG_EARTHQUAKE}
            [delay]
                time=1000
            [/delay]
            [endlevel]
                result=victory
                linger_mode=yes
                bonus=no
            [/endlevel]
        [/event]
    [/event]

    [event]
        name=victory
        {CLEAR_SCENARIO_VARIABLES}
        {CLEAR_CAMPAIGN_VARIABLES}

        [message]
            side=1
            message=_"Victory!"
        [/message]
        # (some of the things mentioned by timeline.txt might have to be moved into an epilogue scenario)
    [/event]
    {HERO_DEATHS}
[/scenario]

#undef INITIALIZE_CAMPAIGN_VARIABLES
#undef CLEAR_CAMPAIGN_VARIABLES
#undef INITIALIZE_SCENARIO_VARIABLES
#undef CLEAR_SCENARIO_VARIABLES
#undef CAVERNS_OF_FLAME
